/**
 *  @license dcore.js
 *  Copyright Â© 2018 Valentin Lozev
 *  Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 *  Source code: http://github.com/valentin-lozev/dcore
 */
!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global.dcore={})}(this,function(exports){"use strict";"function"!=typeof Object.assign&&(Object.assign=function(target){if(null===target)throw new TypeError("Cannot convert undefined or null to object");for(var to=Object(target),index=1;index<arguments.length;index++){var nextSource=arguments[index];if(null!==nextSource)for(var nextKey in nextSource)Object.prototype.hasOwnProperty.call(nextSource,nextKey)&&(to[nextKey]=nextSource[nextKey])}return to}),"function"!=typeof Array.prototype.reduceRight&&(Array.prototype.reduceRight=function(callback){if(null===this||void 0===this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof callback)throw new TypeError(callback+" is not a function");var value,t=Object(this),k=(t.length>>>0)-1;if(arguments.length>=2)value=arguments[1];else{for(;k>=0&&!(k in t);)k--;if(k<0)throw new TypeError("Reduce of empty array with no initial value");value=t[k--]}for(;k>=0;k--)k in t&&(value=callback(value,t[k],k,t));return value});var Sandbox=function(){function Sandbox(dcore,moduleId,instanceId){this._extensionsOnlyCore=dcore,this._moduleId=moduleId,this._instanceId=instanceId}return Object.defineProperty(Sandbox.prototype,"moduleId",{get:function(){return this._moduleId},enumerable:!0,configurable:!0}),Object.defineProperty(Sandbox.prototype,"instanceId",{get:function(){return this._instanceId},enumerable:!0,configurable:!0}),Sandbox.prototype.startModule=function(id,options){this._extensionsOnlyCore.startModule(id,options)},Sandbox.prototype.stopModule=function(id,instanceId){this._extensionsOnlyCore.stopModule(id,instanceId)},Sandbox.prototype.publishAsync=function(message){this._extensionsOnlyCore.publishAsync(message)},Sandbox}(),guard=new(function(){function ArgumentGuard(){}return ArgumentGuard.prototype.array=function(arg,msg){if(!Array.isArray(arg))throw new Error(msg);return this},ArgumentGuard.prototype.defined=function(arg,msg){if(void 0===arg||null===arg)throw new Error(msg);return this},ArgumentGuard.prototype.undefined=function(arg,msg){if(void 0!==arg&&null!==arg)throw new Error(msg);return this},ArgumentGuard.prototype.object=function(arg,msg){if("object"!=typeof arg||null===arg)throw new Error(msg);return this},ArgumentGuard.prototype.function=function(arg,msg){if("function"!=typeof arg)throw new Error(msg);return this},ArgumentGuard.prototype.nonEmptyString=function(arg,msg){if("string"!=typeof arg||!arg.length)throw new Error(msg);return this},ArgumentGuard.prototype.true=function(arg,msg){if(!arg)throw new Error(msg);return this},ArgumentGuard.prototype.false=function(arg,msg){if(arg)throw new Error(msg);return this},ArgumentGuard}()),lastUID=0,HooksBehavior=function(){function HooksBehavior(){this._plugins=Object.create(null)}return HooksBehavior.prototype.createPipeline=function(hook,method){guard.nonEmptyString(hook,"decorate(): hook must be a non empty string").function(method,'decorate(): "'+hook+'" method must be a function');var pipelineContext=this,result=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var plugins=pipelineContext._plugins[hook];return plugins?plugins.reduceRight(function(pipeline,plugin){return function(){return plugin.apply(_this,[pipeline].concat(args))}},function(){return method.apply(_this,args)})():method.apply(this,args)};return result._withPipeline=!0,result._hook=hook,result},HooksBehavior.prototype.addPlugin=function(hook,plugin){guard.nonEmptyString(hook,"addPlugin(): hook must be a non empty string").function(plugin,"addPlugin(): plugin must be a function"),(this._plugins[hook]||(this._plugins[hook]=[])).push(plugin)},HooksBehavior}(),MessageBus=function(){function MessageBus(){this._subscribers=Object.create(null)}return MessageBus.prototype.onMessage=function(messageType,handler){return guard.function(handler,"onMessages(): message handler should be a function").nonEmptyString(messageType,"onMessage(): message type must be a non empty string"),this._addSubscriber(messageType,handler)},MessageBus.prototype.publishAsync=function(message){var _this=this;if(guard.true("object"==typeof message,"publishAsync(): message must be an object with defined type property as string"),message.type in this._subscribers){var subscriptions=this._subscribers[message.type];Object.keys(subscriptions).forEach(function(id){_this._publishSingle(message,subscriptions[id])})}},MessageBus.prototype._publishSingle=function(message,handler){setTimeout(function(){try{handler(message)}catch(err){console.error('publishAsync(): Receive "'+message.type+'" message failed.'),console.error(err)}},0)},MessageBus.prototype._addSubscriber=function(type,handler){var _this=this;type in this._subscribers||(this._subscribers[type]=Object.create(null));var subscriptionId=++lastUID;return this._subscribers[type][subscriptionId]=handler,function(){_this._subscribers[type][subscriptionId]=null,delete _this._subscribers[type][subscriptionId]}},MessageBus}(),DCore=function(){function DCore(hooksBehavior,messageBus){void 0===hooksBehavior&&(hooksBehavior=new HooksBehavior),void 0===messageBus&&(messageBus=new MessageBus),this.Sandbox=Sandbox,this._isInitialized=!1,this._onInit=null,this._hooksBehavior=null,this._messageBus=null,this._extensions=Object.create(null),this._modules=Object.create(null),this._hooksBehavior=hooksBehavior,this._messageBus=messageBus,this._onDomReady=this._onDomReady.bind(this),this.use([{name:"module-autosubscribe",install:function(){return{onModuleInit:function(next){next(),function(){var _this=this,messages=this.messages;if(Array.isArray(messages)&&0!==messages.length){guard.function(this.handleMessage,"handleMessage method must be implemented in order to subscribe to given messages"),this.handleMessage=this.handleMessage.bind(this);var dcore=this.sandbox._extensionsOnlyCore;this.sandbox.unsubscribers=messages.reduce(function(map,message){return map[message]=dcore.onMessage(message,_this.handleMessage),map},Object.create(null))}}.call(this)},onModuleDestroy:function(next){(function(){var unsubscribers=this.sandbox.unsubscribers;unsubscribers&&Object.keys(unsubscribers).forEach(function(message){unsubscribers[message](),unsubscribers[message]=null,delete unsubscribers[message]})}).call(this),next()}}}}])}return Object.defineProperty(DCore.prototype,"version",{get:function(){return"3.0.0"},enumerable:!0,configurable:!0}),DCore.prototype.use=function(extensions){var _this=this;guard.false(this._isInitialized,"use(): extensions must be installed before init").array(extensions,"use(): extensions must be passed as an array"),extensions.forEach(function(x){guard.object(x,"use(): extension must be an object").nonEmptyString(x.name,"use(): extension name must be a non empty string").function(x.install,'use(): "'+x.name+"\" extension's install must be a function").false(x.name in _this._extensions,'use(): "'+x.name+'" extension has already been installed'),_this._extensions[x.name]=x})},DCore.prototype.createPipeline=function(hook,method){return this._hooksBehavior.createPipeline(hook,method)},DCore.prototype.init=function(onInit){guard.false(this._isInitialized,"init(): has already been initialized"),this._onInit=this.createPipeline("onCoreInit",onInit||function(){}),this._initHooks(),this._installExtensions(),"complete"===document.readyState||"interactive"===document.readyState||"loaded"===document.readyState?setTimeout(this._onDomReady,0):document.addEventListener("DOMContentLoaded",this._onDomReady),this._isInitialized=!0},DCore.prototype.addModule=function(id,factory){guard.nonEmptyString(id,"addModule(): id must be a non empty string").undefined(this._modules[id],'addModule(): "'+id+'" has already been added').function(factory,'addModule(): "'+id+'" factory must be a function'),this._modules[id]={factory:factory,instances:Object.create(null)}},DCore.prototype.startModule=function(id,options){void 0===options&&(options={});var moduleData=this._modules[id];guard.true(this._isInitialized,"startModule(): dcore must be initialized first").defined(moduleData,'startModule(): "'+id+'" not found');var instanceId=options.instanceId||id;if(instanceId in moduleData.instances)console.warn('startModule(): "'+id+'" "'+instanceId+'" has already been initialized');else{var instance=this._createModule(id,instanceId,moduleData.factory);if(instance)try{this.createPipeline("onModuleInit",instance.init).call(instance,options.props),moduleData.instances[instanceId]=instance}catch(err){console.error('startModule(): "'+id+'" init failed'),console.error(err)}}},DCore.prototype.stopModule=function(id,instanceId){var moduleData=this._modules[id];if(moduleData)if((instanceId=instanceId||id)in moduleData.instances)try{var instance=moduleData.instances[instanceId];this.createPipeline("onModuleDestroy",instance.destroy).call(instance),delete moduleData.instances[instanceId]}catch(err){console.error('stopModule(): "'+id+'" destroy failed'),console.error(err)}else console.warn('stopModule(): "'+id+'"\'s "'+instanceId+'" instance is not running');else console.warn('stopModule(): "'+id+'" not found')},DCore.prototype.onMessage=function(messageType,handler){return this._messageBus.onMessage(messageType,handler)},DCore.prototype.publishAsync=function(message){this._messageBus.publishAsync(message)},DCore.prototype.listExtensions=function(){return Object.keys(this._extensions)},DCore.prototype.listModules=function(){return Object.keys(this._modules)},DCore.prototype.listRunningModules=function(){var _this=this;return this.listModules().reduce(function(result,id){return result[id]=Object.keys(_this._modules[id].instances),result},Object.create(null))},DCore.prototype._initHooks=function(){this.addModule=this.createPipeline("onModuleAdd",this.addModule),this.startModule=this.createPipeline("onModuleStart",this.startModule),this.stopModule=this.createPipeline("onModuleStop",this.stopModule),this.onMessage=this.createPipeline("onMessageSubscribe",this.onMessage),this.publishAsync=this.createPipeline("onMessagePublish",this.publishAsync)},DCore.prototype._installExtensions=function(){var _this=this;Object.keys(this._extensions).forEach(function(name){return _this._install(_this._extensions[name])})},DCore.prototype._install=function(extension){var _this=this,plugins=extension.install(this)||{};Object.keys(plugins).forEach(function(hook){return _this._hooksBehavior.addPlugin(hook,plugins[hook])})},DCore.prototype._onDomReady=function(){document.removeEventListener("DOMContentLoaded",this._onDomReady),this._onInit()},DCore.prototype._createModule=function(id,instanceId,factory){var result=null;try{result=factory(new this.Sandbox(this,id,instanceId)),guard.true(result.sandbox instanceof this.Sandbox,'startModule(): "'+id+'.sandbox" must be a Sandbox instance').function(result.init,'startModule(): "'+id+'" must implement init method').function(result.destroy,'startModule(): "'+id+'" must implement destroy method')}catch(err){result=null,console.error(err)}return result},DCore}();exports.DCore=DCore,Object.defineProperty(exports,"__esModule",{value:!0})});
